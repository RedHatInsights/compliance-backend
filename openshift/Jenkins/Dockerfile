FROM registry.access.redhat.com/openshift3/jenkins-slave-base-rhel7

ENV RUBY_MAJOR_VERSION=2 \
    RUBY_MINOR_VERSION=5

ENV RUBY_VERSION="${RUBY_MAJOR_VERSION}.${RUBY_MINOR_VERSION}" \
    RUBY_SCL_NAME_VERSION="${RUBY_MAJOR_VERSION}${RUBY_MINOR_VERSION}"

ENV RUBY_SCL="rh-ruby${RUBY_SCL_NAME_VERSION}"

RUN yum install -y yum-utils https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm && \
    yum-config-manager --enable rhel-7-server-extras-rpms rhel-7-server-rpms rhel-7-server-optional-rpms rhel-server-rhscl-7-rpms && \
    yum install -y dnf && \
    INSTALL_PKGS=" \
${RUBY_SCL} \
${RUBY_SCL}-ruby-devel \
${RUBY_SCL}-rubygem-rake \
${RUBY_SCL}-rubygem-bundler \
openscap \
gcc-c++ \
make \
libxml2-devel \
patch \
postgresql-devel \
qt5-qtwebkit-devel" && \
    dnf install -y --setopt=tsflags=nodocs ${INSTALL_PKGS} && \
    dnf clean all -y && \
    yum clean all -y && \
    rpm -V ${INSTALL_PKGS}

COPY Gemfile Gemfile.lock ./

ENV LC_ALL="en_US.UTF-8" \
    LANG="en_US.UTF-8" \
    PATH="$PATH:/opt/rh/$RUBY_SCL/root/usr/bin" \
    LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/opt/rh/$RUBY_SCL/root/usr/lib64" \
    MANPATH="$MANPATH:/opt/rh/$RUBY_SCL/root/usr/share/man" \
    PKG_CONFIG_PATH="$PKG_CONFIG_PATH:/opt/rh/$RUBY_SCL/root/usr/lib64/pkgconfig" \
    XDG_DATA_DIRS="$XDG_DATA_DIRS:/opt/rh/$RUBY_SCL/root/usr/share" \
    X_SCLS="$RUBY_SCL" \
    QMAKE="/usr/lib64/qt5/bin/qmake" \
    BUNDLE_PATH="/tmp/bundle" \
    BUNDLE_BIN="/tmp/bundle/bin"

RUN bundle install && \
    rm Gemfile Gemfile.lock && \
    chown -R 1001:0 $BUNDLE_PATH && \
    chmod -R g+rw $BUNDLE_PATH

USER 1001
