GraphQL::Cache.configure do |config|
  config.namespace = 'compliance' # Cache key prefix for keys generated by graphql-cache
  config.cache     = Rails.cache      # The cache object to use for caching
  config.logger    = Rails.logger     # Logger to receive cache-related log messages
  config.expiry    = 15552000         # 6 months (in seconds)
end

module GraphQL
  module Cache
    module DeconstructorExtensions
      def perform
        return raw.value if method == 'lazy'
        if raw.is_a?(Promise)
          raw.wait
          raw.value
        end
        super
      end
    end

    class Deconstructor
      prepend DeconstructorExtensions
    end

    class Key
      def to_s
        @to_s ||= [
          GraphQL::Cache.namespace,
          object_clause,
          arguments_clause,
          field_clause,
        ].flatten.compact.join(':')
      end
    end
  end
end
